{% extends 'base.html' %}

{% block title %}百速AI一键生成短视频 - 首页{% endblock %}

{% block content %}
<div class="home-container">
    <!-- 标题区域 -->
    <div class="hero-section">
        <h1 class="main-title">百速AI一键生成短视频</h1>
        <div class="subtitle">输入提示词或者文案，选择模板和风格，一键生成视频</div>
    </div>

    <!-- 输入区域（新位置，标题下方） -->
    <div class="input-area-rebuild">
        <div class="input-area-box">
            <!-- 模式切换（移到上面） -->
            <div class="input-mode-switch-bar">
                <span :class="['mode-label', { 'active': inputMode === 'prompt', 'disabled': selectedTemplate === '读一本书' }]">提示词</span>
                <el-switch
                    v-model="inputMode"
                    active-value="script"
                    inactive-value="prompt"
                    @change="onModeChange"
                    :disabled="selectedTemplate === '读一本书'"
                    class="mode-toggle">
                </el-switch>
                <span :class="['mode-label', { 'active': inputMode === 'script', 'disabled': selectedTemplate === '读一本书' }]">文案</span>
            </div>
            
            <!-- 输入框及齿轮 -->
            <div class="input-box-with-gear">
                <el-input
                    type="textarea"
                    :rows="inputMode === 'prompt' ? 3 : 6"
                    :placeholder="inputMode === 'prompt' ? '请输入视频内容提示词快速生成视频，例如：生成一个关于减轻压力的心理学的视频，选择一个安徒生童话生成视频' : '请将撰写好的文案粘贴到文本框中生成视频'"
                    v-model="prompt"
                    :class="['prompt-input', { 'small-font': prompt.length > 80 }]"
                    @input="onPromptInput">
                </el-input>
                <span class="gear-icon" @click="toggleSettings">
                    <i class="fas fa-cog"></i>
                </span>
            </div>
            
            <!-- 额度预估提示 -->
            <div v-if="shouldShowCreditsWarning" class="credits-warning">
                <i class="fas fa-info-circle"></i>
                <span>*预计会扣取<span v-text="estimatedCredits"></span>条额度（当前文案<span v-text="prompt.length"></span>字）</span>
            </div>
            
            <!-- 读一本书额外输入 - 新布局 -->
            <div v-if="selectedTemplate === '读一本书'" class="book-extra-section">
                <div class="book-input-item">
                    <span class="book-input-label">1. 请上传书籍封面</span>
                    <label class="book-cover-upload-btn" for="bookCoverInput">
                        <i class="fas fa-upload"></i>
                        选择封面
                    </label>
                    <input type="file" id="bookCoverInput" @change="handleBookCoverChange" accept="image/*" style="display: none;">
                </div>
                <div v-if="bookCoverUrl" class="book-cover-preview">
                    <img :src="bookCoverUrl" alt="书籍封面">
                    <span class="cover-name">已选择封面</span>
                </div>
                
                <div class="book-input-item">
                    <span class="book-input-label">2. 请输入书名</span>
                    <el-input
                        v-model="bookTitle"
                        placeholder="请输入书本名称"
                        class="book-title-input-new">
                    </el-input>
                </div>
            </div>
        </div>
        
        <!-- 生成按钮（移到输入框外的右下方） -->
        <div class="generate-btn-container">
            <el-button type="primary" size="medium" @click="generateVideo" :loading="isGenerating" :disabled="!canGenerate || isGenerating">
                <span v-if="isGenerating">生成中...</span>
                <span v-else>生成视频</span>
            </el-button>
        </div>
        
        <!-- 设置弹窗 -->
        <el-dialog 
            title="视频设置" 
            :visible.sync="showSettings" 
            width="320px" 
            class="settings-dialog"
            :close-on-click-modal="true"
            :close-on-press-escape="true"
            :show-close="true"
            :modal="true"
            :modal-append-to-body="true"
            :append-to-body="true"
            @close="handleSettingsClose"
            @open="handleSettingsOpen">
            <div class="setting-row checkbox-row">
                <el-checkbox v-model="isDisplayTitle">右上角显示标题</el-checkbox>
            </div>
            <div class="setting-row">
                <div class="username-section">
                    <div class="username-row">
                        <el-checkbox v-model="showUserName" :disabled="!isVipUser">左上角显示账户名</el-checkbox>
                    </div>
                    <div class="username-row">
                        <span class="username-label">@</span>
                        <el-input
                            v-model="userName"
                            :placeholder="isVipUser ? '账号名称' : ''"
                            :disabled="!isVipUser || !showUserName"
                            :value="!isVipUser ? '百速AI' : userName"
                            class="username-input"
                            :class="{ 'disabled': !isVipUser || !showUserName }">
                        </el-input>
                    </div>
                    <div v-if="!isVipUser" class="vip-notice">* 仅会员可自定义账号名称</div>
                </div>
            </div>
        </el-dialog>
    </div>

    <!-- 模板选择区域 -->
    <div class="template-section centered">
        <h3>选择视频模板</h3>
        <div class="template-slider-container">
            <div class="slider-nav slider-nav-left" @click="scrollTemplateLeft">
                <i class="fas fa-chevron-left"></i>
            </div>
            <div class="template-slider" ref="templateSlider">
                <div class="template-grid">
                    <div class="template-card" 
                         :class="{ 'active': selectedTemplate === '通用' }" 
                         @click="selectTemplate('通用')"
                         @mouseenter="playVideo('通用')"
                         @mouseleave="pauseVideo('通用')">
                        <video ref="video通用" muted loop>
                            <source src="/static/video/preview/通用_preview.mp4" type="video/mp4">
                        </video>
                        <div class="template-info">
                            <h4>通用</h4>
                            <p>可以生成心理学科普，教育，解说等普通视频</p>
                        </div>
                    </div>
                    <div class="template-card" 
                         :class="{ 'active': selectedTemplate === '读一本书' }" 
                         @click="selectTemplate('读一本书')"
                         @mouseenter="playVideo('读一本书')"
                         @mouseleave="pauseVideo('读一本书')">
                        <video ref="video读一本书" muted loop>
                            <source src="/static/video/preview/读一本书_preview.mp4" type="video/mp4">
                        </video>
                        <div class="template-info">
                            <h4>读一本书</h4>
                            <p>用于生成读一本书视频，需要上传书本封面图片和给出书名，并且给出视频文案，仅支持文案模式</p>
                        </div>
                    </div>
                    <div class="template-card" 
                         :class="{ 'active': selectedTemplate === '故事' }" 
                         @click="selectTemplate('故事')"
                         @mouseenter="playVideo('故事')"
                         @mouseleave="pauseVideo('故事')">
                        <video ref="video故事" muted loop>
                            <source src="/static/video/preview/故事_preview.mp4" type="video/mp4">
                        </video>
                        <div class="template-info">
                            <h4>故事</h4>
                            <p>用于生成故事类视频</p>
                        </div>
                    </div>
                    <div class="template-card" 
                         :class="{ 'active': selectedTemplate === '讲经' }" 
                         @click="selectTemplate('讲经')"
                         @mouseenter="playVideo('讲经')"
                         @mouseleave="pauseVideo('讲经')">
                        <video ref="video讲经" muted loop>
                            <source src="/static/video/preview/讲经_preview.mp4" type="video/mp4">
                        </video>
                        <div class="template-info">
                            <h4>讲经</h4>
                            <p>用于生成解读经典，玄学等视频</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="slider-nav slider-nav-right" @click="scrollTemplateRight">
                <i class="fas fa-chevron-right"></i>
            </div>
        </div>
    </div>

    <!-- 风格选择区域 -->
    <div class="style-section centered">
        <h3>选择视频风格</h3>
        <div class="style-slider-container">
            <div class="slider-nav slider-nav-left" @click="scrollStyleLeft">
                <i class="fas fa-chevron-left"></i>
            </div>
            <div class="style-slider" ref="styleSlider">
                <div class="style-grid">
                    {% for style_name, style_img in styles.items() %}
                    <div class="style-card" :class="{ 'active': selectedStyle === '{{ style_name|safe }}' }" @click="selectStyle('{{ style_name|safe }}')">
                        <img src="{{ style_img }}" alt="{{ style_name }}">
                        <p>{{ style_name }}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="slider-nav slider-nav-right" @click="scrollStyleRight">
                <i class="fas fa-chevron-right"></i>
            </div>
        </div>
    </div>

    <!-- 登录提示 -->
    <el-dialog
        title="需要登录"
        :visible.sync="showLoginDialog"
        width="30%">
        <span>请先登录后再生成视频</span>
        <span slot="footer" class="dialog-footer">
            <el-button @click="showLoginDialog = false">取消</el-button>
            <el-button type="primary" @click="goToLogin">去登录</el-button>
        </span>
    </el-dialog>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 等待DOM加载完成后创建Vue实例
    document.addEventListener('DOMContentLoaded', function() {
        // 检查是否已存在Vue实例
        if (window.indexVueInstance) {
            window.indexVueInstance.$destroy();
        }
        
        // 使用现代化的Vue实例创建方式
        window.indexVueInstance = window.AppConfig.createVue({
            el: '.home-container',
        data() {
            return {
                selectedTemplate: '通用',
                selectedStyle: '绘本',
                inputMode: 'prompt',
                prompt: '',
                bookCoverUrl: '',
                bookCoverFile: null,
                bookTitle: '',
                isDisplayTitle: true,
                userName: '',
                isGenerating: false,
                showLoginDialog: false,
                showSettings: false,
                showUserName: false,
                ttsModelStr: 'cosyvoice-v1',
            };
        },
        mounted() {
            console.log('Vue instance mounted');
            console.log('window.AppConfig.globalData:', window.AppConfig.globalData);
            console.log('this.$global:', this.$global);
            console.log('User authenticated:', this.isAuthenticated);
            console.log('User info from $global:', this.$global?.user);
            console.log('User info from window:', window.AppConfig.globalData?.user);
        },
        computed: {
            // 使用计算属性获取用户信息，直接从window.AppConfig获取
            isVipUser() {
                const globalData = window.AppConfig && window.AppConfig.globalData;
                return globalData && globalData.user && globalData.user.isVip;
            },
            isAuthenticated() {
                const globalData = window.AppConfig && window.AppConfig.globalData;
                return globalData && globalData.user && globalData.user.isAuthenticated;
            },
            canGenerate() {
                if (this.selectedTemplate === '读一本书') {
                    return this.prompt && this.bookTitle && this.bookCoverFile;
                } else {
                    return this.prompt;
                }
            },
            // 计算预估消耗的额度
            estimatedCredits() {
                if (this.inputMode === 'script' && this.prompt) {
                    const charCount = this.prompt.length;
                    return Math.max(1, Math.ceil(charCount / 2000));
                }
                return 1;
            },
            // 是否显示额度警告
            shouldShowCreditsWarning() {
                return this.inputMode === 'script' && this.prompt && this.prompt.length > 2000;
            }
        },
        methods: {
            selectTemplate(template) {
                this.selectedTemplate = template;
                if (template === '读一本书') {
                    this.inputMode = 'script';
                }
                // 所有模板都使用 speech-02-turbo 模型
                this.ttsModelStr = 'speech-02-turbo';
            },
            selectStyle(style) {
                this.selectedStyle = style;
            },
            onModeChange() {
                this.prompt = '';
            },
            handleBookCoverChange(event) {
                const file = event.target.files[0];
                if (file) {
                    this.bookCoverFile = file;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.bookCoverUrl = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            },
            playVideo(template) {
                try {
                    const video = this.$refs['video' + template];
                    console.log('Playing video for template:', template, video);
                    if (video) {
                        // 如果是数组，取第一个元素，否则直接使用
                        const videoElement = Array.isArray(video) ? video[0] : video;
                        if (videoElement && videoElement.play) {
                            // 设置播放参数：从第2秒开始，2倍速播放
                            videoElement.currentTime = 2;
                            videoElement.playbackRate = 2.0;
                            videoElement.play().catch(e => {
                                console.log('Video play failed:', e);
                            });
                        }
                    }
                } catch (e) {
                    console.log('Error playing video:', e);
                }
            },
            pauseVideo(template) {
                try {
                    const video = this.$refs['video' + template];
                    console.log('Pausing video for template:', template, video);
                    if (video) {
                        // 如果是数组，取第一个元素，否则直接使用
                        const videoElement = Array.isArray(video) ? video[0] : video;
                        if (videoElement && videoElement.pause) {
                            videoElement.pause();
                            videoElement.currentTime = 0;
                        }
                    }
                } catch (e) {
                    console.log('Error pausing video:', e);
                }
            },
            generateVideo() {
                console.log('generateVideo called');
                console.log('window.AppConfig.globalData:', window.AppConfig.globalData);
                console.log('this.$global:', this.$global);
                console.log('this.isAuthenticated:', this.isAuthenticated);
                
                if (!this.isAuthenticated) {
                    console.log('User not authenticated, showing login dialog');
                    this.showLoginDialog = true;
                    return;
                }
                
                if (!this.canGenerate) {
                    this.$message.warning('请完善必要信息');
                    return;
                }
                
                // 检查额度是否足够
                const globalData = window.AppConfig && window.AppConfig.globalData;
                const userCredits = globalData && globalData.user && globalData.user.credits || 0;
                if (userCredits < this.estimatedCredits) {
                    this.$message.error(`额度不足！需要${this.estimatedCredits}条额度，当前剩余${userCredits}条`);
                    return;
                }
                    
                this.isGenerating = true;
                
                const formData = new FormData();
                formData.append('template', this.selectedTemplate);
                formData.append('style', this.selectedStyle);
                formData.append('mode', this.inputMode);
                formData.append('prompt', this.prompt);
                formData.append('is_display_title', this.isDisplayTitle);
                formData.append('estimated_credits', this.estimatedCredits); // 传递预估额度
                formData.append('tts_model_str', this.ttsModelStr);
                
                // 用户名逻辑：只有当勾选显示且有用户名时，才使用用户名，否则不显示
                let finalUserName = null; // 默认不显示
                if (this.showUserName && this.userName && this.userName.trim() !== '') {
                    finalUserName = this.userName.trim();
                }
                // 只有当用户名不为null时才添加到formData中
                if (finalUserName !== null) {
                    formData.append('user_name', finalUserName);
                }
                
                if (this.selectedTemplate === '读一本书') {
                    formData.append('book_title', this.bookTitle);
                    if (this.bookCoverFile) {
                        formData.append('book_cover', this.bookCoverFile);
                    }
                }
                
                axios.post('/api/generate-video-v3', formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                })
                .then(response => {
                    if (response.data.success) {
                        window.location.href = `/generate/${response.data.video_id}`;
                    } else {
                        this.$message.error(response.data.message || '生成失败');
                        this.isGenerating = false;
                    }
                })
                .catch(error => {
                    console.error('生成视频失败:', error);
                    this.$message.error('生成失败，请重试');
                    this.isGenerating = false;
                });
            },
            goToLogin() {
                window.location.href = '/login';
            },
            handleSettingsClose() {
                // 确保弹窗完全关闭
                this.showSettings = false;
                console.log('Settings dialog closed');
            },
            handleSettingsOpen() {
                // 弹窗打开时的处理逻辑
                console.log('Settings dialog opened');
            },
            toggleSettings() {
                this.showSettings = !this.showSettings;
                console.log('Toggle settings dialog:', this.showSettings);
            },
            onPromptInput() {
                // 实现输入框内容变化时的处理逻辑
                console.log('Prompt input changed:', this.prompt);
            },
            // 模板滑动方法
            scrollTemplateLeft() {
                const slider = this.$refs.templateSlider;
                if (slider) {
                    slider.scrollBy({
                        left: -300,
                        behavior: 'smooth'
                    });
                }
            },
            scrollTemplateRight() {
                const slider = this.$refs.templateSlider;
                if (slider) {
                    slider.scrollBy({
                        left: 300,
                        behavior: 'smooth'
                    });
                }
            },
            // 风格滑动方法
            scrollStyleLeft() {
                const slider = this.$refs.styleSlider;
                if (slider) {
                    slider.scrollBy({
                        left: -250,
                        behavior: 'smooth'
                    });
                }
            },
            scrollStyleRight() {
                const slider = this.$refs.styleSlider;
                if (slider) {
                    slider.scrollBy({
                        left: 250,
                        behavior: 'smooth'
                    });
                }
            }
        }
        });
    });
</script>
{% endblock %} 