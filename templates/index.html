{% extends 'base.html' %}

{% block title %}百速一键AI视频生成 - 首页{% endblock %}

{% block content %}
<div class="home-container">
    <!-- 标题区域 -->
    <div class="hero-section">
        <h1 class="main-title">百速一键AI视频生成</h1>
        <p class="subtitle">选择模板，输入内容，一键生成精美AI视频</p>
    </div>

    <!-- 主要内容区域 - 使用外框包装 -->
    <div class="main-content-wrapper">
        <!-- 输入区域 - 移到最上面 -->
        <div class="input-section">
            <div class="input-header">
                <h3>输入内容</h3>
                <!-- 提示词/文案选择 - 仅在非读一本书模板时显示 -->
                <div v-if="selectedTemplate !== '读一本书'" class="mode-switch">
                    <span class="mode-label" :class="{ 'active': inputMode === 'prompt' }">提示词</span>
                    <el-switch
                        v-model="inputMode"
                        active-value="script"
                        inactive-value="prompt"
                        @change="onModeChange"
                        class="mode-toggle">
                    </el-switch>
                    <span class="mode-label" :class="{ 'active': inputMode === 'script' }">文案</span>
                </div>
                <!-- 读一本书模板时显示锁定状态 -->
                <div v-else class="mode-locked">
                    <span class="mode-label active">文案模式</span>
                    <i class="el-icon-lock"></i>
                </div>
            </div>
            
            <!-- 文本输入框 -->
            <el-input
                type="textarea"
                :rows="inputMode === 'prompt' ? 4 : 8"
                :placeholder="inputMode === 'prompt' ? '请输入视频内容提示词，例如：以很多人都有的心理困扰问题，选择一个主题，做一个分析和如何解决的视频' : '请输入完整文案内容，将根据文案自动生成视频'"
                v-model="prompt"
                class="prompt-input">
            </el-input>

            <!-- 读一本书模板的额外输入区域 -->
            <div v-if="selectedTemplate === '读一本书'" class="book-extra-inputs">
                <div class="book-input-row">
                    <div class="book-upload-section">
                        <label>上传书本封面</label>
                        <el-upload
                            class="book-cover-uploader"
                            action="#"
                            :auto-upload="false"
                            :on-change="handleBookCoverChange"
                            :show-file-list="false"
                            accept="image/*">
                            <img v-if="bookCoverUrl" :src="bookCoverUrl" class="book-cover">
                            <i v-else class="el-icon-plus book-cover-uploader-icon"></i>
                        </el-upload>
                    </div>
                    
                    <div class="book-title-section">
                        <label>书本名称</label>
                        <el-input
                            v-model="bookTitle"
                            placeholder="请输入书本名称"
                            class="book-title-input">
                        </el-input>
                    </div>
                </div>
            </div>

            <!-- 通用设置 -->
            <div class="common-settings">
                <div class="setting-row">
                    <el-checkbox v-model="isDisplayTitle">在右上角显示视频标题</el-checkbox>
                </div>
                
                <div class="setting-row">
                    <label>用户名（可选）：</label>
                    <el-input
                        v-model="userName"
                        placeholder="请输入用户名，将在视频左上角显示"
                        :disabled="!isVipUser"
                        class="username-input">
                    </el-input>
                    <span v-if="!isVipUser" class="vip-notice">* 仅会员可自定义用户名</span>
                </div>
            </div>
        </div>

        <!-- 模板选择区域 -->
        <div class="template-section">
            <h3>选择视频模板</h3>
            <div class="template-grid">
                <div class="template-card" 
                     :class="{ 'active': selectedTemplate === '通用' }" 
                     @click="selectTemplate('通用')"
                     @mouseenter="playVideo('通用')"
                     @mouseleave="pauseVideo('通用')">
                    <video ref="video通用" muted loop>
                        <source src="/static/video/通用.mp4" type="video/mp4">
                    </video>
                    <div class="template-info">
                        <h4>通用</h4>
                        <p>可以生成心理学科普，教育，解说等普通视频</p>
                    </div>
                </div>
                
                <div class="template-card" 
                     :class="{ 'active': selectedTemplate === '读一本书' }" 
                     @click="selectTemplate('读一本书')"
                     @mouseenter="playVideo('读一本书')"
                     @mouseleave="pauseVideo('读一本书')">
                    <video ref="video读一本书" muted loop>
                        <source src="/static/video/读一本书.mp4" type="video/mp4">
                    </video>
                    <div class="template-info">
                        <h4>读一本书</h4>
                        <p>用于生成读一本书视频，需要上传书本封面图片和给出书名，并且给出视频文案，仅支持文案模式</p>
                    </div>
                </div>
                
                <div class="template-card" 
                     :class="{ 'active': selectedTemplate === '故事' }" 
                     @click="selectTemplate('故事')"
                     @mouseenter="playVideo('故事')"
                     @mouseleave="pauseVideo('故事')">
                    <video ref="video故事" muted loop>
                        <source src="/static/video/故事.mp4" type="video/mp4">
                    </video>
                    <div class="template-info">
                        <h4>故事</h4>
                        <p>用于生成故事类视频</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 风格选择区域 -->
        <div class="style-section">
            <h3>选择视频风格</h3>
            <div class="style-grid">
                {% for style_name, style_img in styles.items() %}
                <div class="style-card" :class="{ 'active': selectedStyle === '{{ style_name|safe }}' }" @click="selectStyle('{{ style_name|safe }}')">
                    <img src="{{ style_img }}" alt="{{ style_name }}">
                    <p>{{ style_name }}</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- 生成按钮 -->
        <div class="action-section">
            <el-button type="primary" size="large" @click="generateVideo" :loading="isGenerating" :disabled="!canGenerate || isGenerating">
                <span v-if="isGenerating">生成中...</span>
                <span v-else>开始生成视频</span>
            </el-button>
        </div>
    </div>

    <!-- 登录提示 -->
    <el-dialog
        title="需要登录"
        :visible.sync="showLoginDialog"
        width="30%">
        <span>请先登录后再生成视频</span>
        <span slot="footer" class="dialog-footer">
            <el-button @click="showLoginDialog = false">取消</el-button>
            <el-button type="primary" @click="goToLogin">去登录</el-button>
        </span>
    </el-dialog>
</div>
{% endblock %}

{% block scripts %}
<script>
    new Vue({
        el: '#app',
        data() {
            return {
                selectedTemplate: '通用', // 默认选择通用模板
                selectedStyle: '3D景深', // 默认风格
                inputMode: 'prompt', // 默认为提示词模式
                prompt: '',
                bookCoverUrl: '',
                bookCoverFile: null,
                bookTitle: '',
                isDisplayTitle: true, // 默认显示标题
                userName: '',
                isGenerating: false,
                showLoginDialog: false,
                isVipUser: {% if current_user.is_authenticated %}{{ 'true' if current_user.is_vip else 'false' }}{% else %}false{% endif %}
            }
        },
        computed: {
            canGenerate() {
                if (this.selectedTemplate === '读一本书') {
                    return this.prompt && this.bookTitle && this.bookCoverFile;
                } else {
                    return this.prompt;
                }
            }
        },
        methods: {
            // 选择模板
            selectTemplate(template) {
                this.selectedTemplate = template;
                // 重置输入内容
                this.prompt = '';
                this.bookCoverUrl = '';
                this.bookCoverFile = null;
                this.bookTitle = '';
                
                // 读一本书模板强制使用文案模式
                if (template === '读一本书') {
                    this.inputMode = 'script';
                }
            },
            
            // 选择风格
            selectStyle(style) {
                this.selectedStyle = style;
            },
            
            // 切换输入模式
            onModeChange() {
                this.prompt = '';
            },
            
            // 处理书本封面上传
            handleBookCoverChange(file) {
                this.bookCoverFile = file.raw;
                this.bookCoverUrl = URL.createObjectURL(file.raw);
            },
            
            // 播放视频
            playVideo(template) {
                const video = this.$refs[`video${template}`];
                if (video) {
                    video.play();
                }
            },
            
            // 暂停视频
            pauseVideo(template) {
                const video = this.$refs[`video${template}`];
                if (video) {
                    video.pause();
                    video.currentTime = 0;
                }
            },
            
            // 生成视频
            generateVideo() {
                // 检查是否登录
                {% if current_user.is_authenticated %}
                    this.startGeneration();
                {% else %}
                    this.showLoginDialog = true;
                {% endif %}
            },
            
            // 开始生成视频
            startGeneration() {
                if (!this.canGenerate) {
                    this.$message.error('请完善所有必填信息');
                    return;
                }
                
                // 准备表单数据
                const formData = new FormData();
                formData.append('prompt', this.prompt);
                formData.append('style', this.selectedStyle);
                formData.append('template', this.selectedTemplate);
                formData.append('mode', this.inputMode);
                formData.append('is_display_title', this.isDisplayTitle);
                formData.append('user_name', this.userName || null);
                
                // 如果是读一本书模板，添加额外数据
                if (this.selectedTemplate === '读一本书') {
                    formData.append('book_title', this.bookTitle);
                    if (this.bookCoverFile) {
                        formData.append('book_cover', this.bookCoverFile);
                    }
                }
                
                this.isGenerating = true;
                
                // 发送生成请求
                axios.post('/api/generate-video-v3', formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                })
                .then(response => {
                    if (response.data.success) {
                        // 跳转到生成页面
                        window.location.href = `/generate/${response.data.video_id}`;
                    } else {
                        this.handleError(response.data.message);
                    }
                })
                .catch(error => {
                    this.handleError(error.response?.data?.message || '生成请求失败');
                })
                .finally(() => {
                    this.isGenerating = false;
                });
            },
            
            // 处理错误
            handleError(message) {
                this.$message.error(message);
            },
            
            // 跳转到登录页
            goToLogin() {
                window.location.href = '{{ url_for("login") }}';
            }
        }
    });
</script>
{% endblock %} 